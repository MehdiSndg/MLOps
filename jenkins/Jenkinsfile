pipeline {
  agent {
    docker {
      image 'mlops-base:latest'
      args '-u root'
    }
  }

  options {
    timestamps()
    ansiColor('xterm')
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Create .env file') {
      steps {
        withCredentials([
          string(credentialsId: 'aws-access-key', variable: 'AWS_ACCESS_KEY_ID'),
          string(credentialsId: 'aws-secret-access-key', variable: 'AWS_SECRET_ACCESS_KEY'),
          string(credentialsId: 'aws-default-region', variable: 'AWS_DEFAULT_REGION'),
          string(credentialsId: 'dvc-bucket-url', variable: 'DVC_BUCKET_URL'),
          string(credentialsId: 'dvc-endpoint', variable: 'DVC_ENDPOINT'),
          string(credentialsId: 'dvc-remote-name', variable: 'DVC_REMOTE_NAME'),
          string(credentialsId: 'mlflow-tracking-uri', variable: 'MLFLOW_TRACKING_URI'),
          string(credentialsId: 'mlflow-port', variable: 'MLFLOW_PORT'),
          string(credentialsId: 'mlflow-backend-uri', variable: 'MLFLOW_BACKEND_URI'),
          string(credentialsId: 'mlflow-artifact-root', variable: 'MLFLOW_ARTIFACT_ROOT'),
          string(credentialsId: 'mlflow-experiment-name', variable: 'MLFLOW_EXPERIMENT'),
          string(credentialsId: 'mlflow-wait-seconds', variable: 'MLFLOW_SERVER_WAIT_SECONDS'),
          string(credentialsId: 'mlflow-auto-start', variable: 'AUTO_START_MLFLOW_SERVER'),
          string(credentialsId: 'log-level', variable: 'LOG_LEVEL')
        ]) {
          sh '''
cat > .env <<EOF
AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION}
DVC_BUCKET_URL=${DVC_BUCKET_URL}
DVC_ENDPOINT=${DVC_ENDPOINT}
DVC_REMOTE_NAME=${DVC_REMOTE_NAME}
MLFLOW_TRACKING_URI=${MLFLOW_TRACKING_URI}
MLFLOW_PORT=${MLFLOW_PORT}
MLFLOW_BACKEND_URI=${MLFLOW_BACKEND_URI}
MLFLOW_ARTIFACT_ROOT=${MLFLOW_ARTIFACT_ROOT}
MLFLOW_EXPERIMENT=${MLFLOW_EXPERIMENT}
MLFLOW_SERVER_WAIT_SECONDS=${MLFLOW_SERVER_WAIT_SECONDS}
AUTO_START_MLFLOW_SERVER=${AUTO_START_MLFLOW_SERVER}
LOG_LEVEL=${LOG_LEVEL}
EOF
'''
        }
      }
    }

    stage('Install Dependencies') {
      steps {
        sh 'pip install --no-cache-dir -r requirements.txt'
      }
    }

    stage('DVC Pull') {
      steps {
        sh '''
set -a
. ./.env
set +a
dvc pull
'''
      }
    }

    stage('Run Pipeline Script') {
      steps {
        sh '''
chmod +x pipeline.sh
set -a
. ./.env
set +a
./pipeline.sh
'''
      }
    }

    stage('ML Security Scan') {
      steps {
        sh '''
python -m venv .sec-venv
. .sec-venv/bin/activate
pip install --upgrade pip
pip install --no-cache-dir bandit safety presidio-analyzer presidio-anonymizer spacy
python -m spacy download en_core_web_sm
bandit -r src -f json -o bandit_report.json || true
safety check --json --file requirements.txt > safety_report.json || true
python src/steps/security/run_presidio_scan.py --input data/processed/processed.csv --output presidio_report.json || true
curl -sSL https://github.com/aquasecurity/trivy/releases/download/v0.56.2/trivy_0.56.2_Linux-64bit.tar.gz -o trivy.tar.gz
tar -xzf trivy.tar.gz
chmod +x trivy
./trivy fs --security-checks vuln,secret --format json --output trivy_report.json . || true
rm -rf trivy trivy.tar.gz
'''
        archiveArtifacts artifacts: 'bandit_report.json,safety_report.json,presidio_report.json,trivy_report.json', allowEmptyArchive: true, fingerprint: true
      }
    }

    stage('Log Security Metrics') {
      steps {
        sh '''
. .sec-venv/bin/activate
python ml_security_logger.py --reports bandit_report.json safety_report.json presidio_report.json trivy_report.json
'''
      }
    }

    stage('Docker Build (Optional)') {
      steps {
        sh '''
if command -v docker >/dev/null 2>&1; then
  docker build -t mlops_app:latest .
else
  echo "Docker CLI not available in this agent. Skipping optional build stage."
fi
'''
      }
    }

    stage('DVC Push') {
      steps {
        sh '''
set -a
. ./.env
set +a
dvc push
'''
      }
    }

    stage('Archive Artifacts') {
      steps {
        archiveArtifacts artifacts: 'artifacts/**/*', allowEmptyArchive: true, fingerprint: true
      }
    }

    stage('Cleanup') {
      steps {
        sh '''
rm -f .env
rm -rf .sec-venv
'''
      }
    }
  }

  post {
    always {
      cleanWs()
    }
  }
}
