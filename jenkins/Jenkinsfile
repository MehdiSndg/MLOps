pipeline {
  agent any

  environment {
    VENV = "${WORKSPACE}/.venv"
    PYTHON = "${env.VENV}/bin/python"
    PIP = "${env.VENV}/bin/pip"
    MLFLOW_PORT = "5001"
    MLFLOW_SERVER_WAIT_SECONDS = "60"
    MLFLOW_EXPERIMENT = "mlops_experiment"
    AUTO_START_MLFLOW_SERVER = "false"
    LOG_LEVEL = "INFO"
  }

  options {
    timestamps()
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Prepare Python') {
      steps {
        sh "python3 -m venv ${env.VENV}"
        sh "\"${env.PIP}\" install --upgrade pip"
      }
    }

    stage('Install Dependencies') {
      steps {
        sh "\"${env.PIP}\" install --no-cache-dir -r requirements.txt"
      }
    }

    stage('Create .env file') {
      steps {
        withCredentials([
            usernamePassword(credentialsId: 'aws-creds', usernameVariable: 'AWS_ACCESS_KEY_ID', passwordVariable: 'AWS_SECRET_ACCESS_KEY'),
            string(credentialsId: 'aws-region', variable: 'AWS_DEFAULT_REGION'),
            string(credentialsId: 'dvc-bucket-url', variable: 'DVC_BUCKET_URL'),
            string(credentialsId: 'dvc-endpoint', variable: 'DVC_ENDPOINT'),
            string(credentialsId: 'dvc-remote-name', variable: 'DVC_REMOTE_NAME'),
            string(credentialsId: 'mlflow-tracking-uri', variable: 'MLFLOW_TRACKING_URI'),
            string(credentialsId: 'mlflow-port', variable: 'MLFLOW_PORT'),
            string(credentialsId: 'mlflow-backend-uri', variable: 'MLFLOW_BACKEND_URI'),
            string(credentialsId: 'mlflow-artifact-root', variable: 'MLFLOW_ARTIFACT_ROOT'),
            string(credentialsId: 'mlflow-experiment-name', variable: 'MLFLOW_EXPERIMENT'),
            string(credentialsId: 'mlflow-wait-seconds', variable: 'MLFLOW_SERVER_WAIT_SECONDS'),
            string(credentialsId: 'mlflow-auto-start', variable: 'AUTO_START_MLFLOW_SERVER'),
            string(credentialsId: 'log-level', variable: 'LOG_LEVEL')
        ]) {
          sh """
cat > .env <<EOF
AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION}
DVC_BUCKET_URL=${DVC_BUCKET_URL}
DVC_ENDPOINT=${DVC_ENDPOINT}
DVC_REMOTE_NAME=${DVC_REMOTE_NAME}
MLFLOW_TRACKING_URI=${MLFLOW_TRACKING_URI}
MLFLOW_PORT=${MLFLOW_PORT}
MLFLOW_BACKEND_URI=${MLFLOW_BACKEND_URI}
MLFLOW_ARTIFACT_ROOT=${MLFLOW_ARTIFACT_ROOT}
MLFLOW_EXPERIMENT=${MLFLOW_EXPERIMENT}
MLFLOW_SERVER_WAIT_SECONDS=${MLFLOW_SERVER_WAIT_SECONDS}
AUTO_START_MLFLOW_SERVER=${AUTO_START_MLFLOW_SERVER}
LOG_LEVEL=${LOG_LEVEL}
EOF
"""
        }
      }
    }

    stage('DVC Pull') {
      steps {
        sh """
set -a
. ./.env
set +a
"${env.PYTHON}" -m dvc pull
"""
      }
    }

    stage('Run Pipelines') {
      steps {
        sh """
set -a
. ./.env
set +a
"${env.PYTHON}" run_pipelines.py --pipeline all
"""
      }
    }

    stage('Docker Build') {
      steps {
        sh "docker build -t mlops_full_pipeline -f docker/Dockerfile ."
      }
    }

    stage('DVC Push') {
      steps {
        sh """
set -a
. ./.env
set +a
"${env.PYTHON}" -m dvc push
"""
      }
    }

    stage('Archive Artifacts') {
      steps {
        archiveArtifacts artifacts: 'artifacts/**/*', fingerprint: true, allowEmptyArchive: true
      }
    }
  }

  post {
    always {
      cleanWs()
    }
  }
}
