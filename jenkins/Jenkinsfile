pipeline {
  agent {
    docker {
      image 'mlops-base:latest'
      args '-u root:root -v /var/run/docker.sock:/var/run/docker.sock'
    }
  }

  options {
    timestamps()
    ansiColor('xterm')
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Create .env file') {
      steps {
        withCredentials([
          string(credentialsId: 'aws-access-key', variable: 'AWS_ACCESS_KEY_ID'),
          string(credentialsId: 'aws-secret-access-key', variable: 'AWS_SECRET_ACCESS_KEY'),
          string(credentialsId: 'aws-default-region', variable: 'AWS_DEFAULT_REGION'),
          string(credentialsId: 'dvc-bucket-url', variable: 'DVC_BUCKET_URL'),
          string(credentialsId: 'dvc-endpoint', variable: 'DVC_ENDPOINT'),
          string(credentialsId: 'dvc-remote-name', variable: 'DVC_REMOTE_NAME'),
          string(credentialsId: 'mlflow-tracking-uri', variable: 'MLFLOW_TRACKING_URI'),
          string(credentialsId: 'mlflow-port', variable: 'MLFLOW_PORT'),
          string(credentialsId: 'mlflow-backend-uri', variable: 'MLFLOW_BACKEND_URI'),
          string(credentialsId: 'mlflow-artifact-root', variable: 'MLFLOW_ARTIFACT_ROOT'),
          string(credentialsId: 'mlflow-experiment-name', variable: 'MLFLOW_EXPERIMENT'),
          string(credentialsId: 'mlflow-wait-seconds', variable: 'MLFLOW_SERVER_WAIT_SECONDS'),
          string(credentialsId: 'mlflow-auto-start', variable: 'AUTO_START_MLFLOW_SERVER'),
          string(credentialsId: 'log-level', variable: 'LOG_LEVEL')
        ]) {
          sh '''
cat > .env <<EOF
AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION}
DVC_BUCKET_URL=${DVC_BUCKET_URL}
DVC_ENDPOINT=${DVC_ENDPOINT}
DVC_REMOTE_NAME=${DVC_REMOTE_NAME}
MLFLOW_TRACKING_URI=${MLFLOW_TRACKING_URI}
MLFLOW_PORT=${MLFLOW_PORT}
MLFLOW_BACKEND_URI=${MLFLOW_BACKEND_URI}
MLFLOW_ARTIFACT_ROOT=${MLFLOW_ARTIFACT_ROOT}
MLFLOW_EXPERIMENT=${MLFLOW_EXPERIMENT}
MLFLOW_SERVER_WAIT_SECONDS=${MLFLOW_SERVER_WAIT_SECONDS}
AUTO_START_MLFLOW_SERVER=${AUTO_START_MLFLOW_SERVER}
LOG_LEVEL=${LOG_LEVEL}
EOF
'''
        }
      }
    }

    stage('Install Dependencies') {
      steps {
        sh 'pip install --no-cache-dir -r requirements.txt'
      }
    }

    stage('DVC Pull') {
      steps {
        sh '''
set -a
. ./.env
set +a
dvc pull
'''
      }
    }

    stage('Run Pipeline Script') {
      steps {
        sh '''
chmod +x pipeline.sh
set -a
. ./.env
set +a
./pipeline.sh
'''
      }
    }

    stage('Promptfoo Security Scan (OWASP + ATLAS)') {
      steps {
        catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
          sh '''
promptfoo eval --config promptfoo.yaml -o promptfoo-results.json --no-table --no-share
'''
        }
        sh '[ -f promptfoo-results.json ] || echo "{}" > promptfoo-results.json'
        archiveArtifacts artifacts: 'promptfoo-results.json', fingerprint: true
      }
    }

    stage('Log Promptfoo to MLflow') {
      steps {
        sh '''
python src/steps/security/log_promptfoo_to_mlflow.py
'''
      }
    }

    stage('Docker Build (Optional)') {
      steps {
        sh '''
if command -v docker >/dev/null 2>&1; then
  docker build -t mlops_app:latest .
else
  echo "Docker CLI not available in this agent. Skipping optional build stage."
fi
'''
      }
    }

    stage('DVC Push') {
      steps {
        sh '''
set -a
. ./.env
set +a
dvc push
'''
      }
    }

    stage('Archive Artifacts') {
      steps {
        archiveArtifacts artifacts: 'artifacts/**/*', allowEmptyArchive: true, fingerprint: true
      }
    }

    stage('Cleanup') {
      steps {
        sh '''
rm -f .env
'''
      }
    }
  }

  post {
    always {
      cleanWs()
    }
  }
}
